---
output: 
  html_document2:
    css: style.css
editor_options:
  markdown:
    wrap: 72
---

```{r echo=FALSE, warning=FALSE, }
library(rmarkdown)
library(latex2exp)
library(kableExtra)
```

# Modelos Estructurales

## Introducción

Los modelos de elección discreta buscan modelar **comportamiento** (toma de decisiones), describiendo la probabilidad de que un agente $n$ elija la alternativa $i$, es decir, $P_{ni}$. Se asume que el individuo decide entre las alternativas tal que éste maximiza sus utilidades $u_{ni}$.

En general, los modelos de decisión discreta se definen como $u_{ni} = v_{ni} + \varepsilon_{ni}$, con $v_{ni}$ la componente determinista y $\varepsilon_{ni}$ la componente estocástica.

A continuación se presentan los modelos estructurales abordados en el curso:

### Modelo Logit

El modelo logit es un modelo de elección discreta ampliamente utilizado para analizar decisiones en las que un individuo selecciona una alternativa entre un conjunto finito de opciones. Este modelo asume que los individuos maximizan su utilidad $u_{ni}$, la cual se divide en una componente determinista (observable) $v_{ni}$ y una estocástica (no observable) $\varepsilon_{ni}$, con la componente estocástica siguiendo una distribución de valor extremo Gumbel tipo 1.

La probabilidad de que un agente $n$ elija la alternativa $i$ viene dada por:

$$P_{ni} = \frac{e^{v_{ni}}}{\sum_j e^{v_{nj}}}$$

Donde los parámetros del modelo pueden ser estimados usando el método de máxima verosimilitud con $v_{ni} = \beta' x_{ni}$:

$$LL(\beta) = \sum_n \sum_i y_{ni} \ln(P_{ni})$$

Con $x_{ni}$ un conjunto de covariables y $y_{ni} = 1$ si $n$ elige la alternativa $i$, 0 en caso contrario.

#### Persistencia de Elección (Lealtad) y Precios de Referencia

En modelos de panel con observaciones repetidas, es posible incorporar efectos dinámicos como la **lealtad** y los **precios de referencia**:

**Lealtad:** Se introduce una variable de lealtad latente $z_{nit}$ que captura la propensión del individuo a repetir elecciones previas:

$$z_{nit} = \lambda z_{nit-1} + (1-\lambda) y_{nit-1}$$

donde $0 \leq \lambda \leq 1$ es un parámetro de decaimiento.

**Precios de Referencia:** Los consumidores comparan precios actuales con un precio de referencia interno formado a partir de precios observados en el pasado:

$$RP_{nit} = \lambda RP_{nit-1} + (1-\lambda) P_{nit-1}$$

La utilidad se especifica incorporando la desviación respecto al precio de referencia:

$$u_{nit} = \alpha_i + \beta_1 P_{nit} - \beta_2(P_{nit} - RP_{nit}) + \delta x_{nit} + \varepsilon_{nit}$$

### Modelo Probit

El modelo probit es un modelo de elección discreta utilizado para analizar decisiones en las que un individuo selecciona una alternativa entre un conjunto finito de opciones. Este modelo asume que los individuos maximizan su utilidad $u_{ni}$, la cual se divide en una componente determinista (observable) $v_{ni}$ y una estocástica (no observable) $\varepsilon_{ni}$, con la componente estocástica siguiendo una **distribución normal estándar**.

Asumiendo que el término del error $\varepsilon_{ni}$ se distribuye normal multivariado centrado en 0:

$$\phi(\varepsilon_n) = \frac{1}{(2\pi)^{I/2} |\Sigma|^{1/2}} e^{-\frac{1}{2} \varepsilon'_n \Sigma^{-1} \varepsilon_n}$$

La matriz de covarianza $\Sigma$ tiene una dimensión $I \times I$, con $I$ la cantidad de alternativas de elección. Como la matriz es simétrica, esta tiene $I(I+1)/2$ parámetros.

La probabilidad de elección se aproxima mediante simulación:

$$\hat{P}_{ni} \approx \frac{1}{R} \sum_{r=1}^R \mathbb{1}[\varepsilon^r_{nj} - \varepsilon^r_{ni} < v_{ni} - v_{nj}, \forall j \neq i]$$

Los parámetros del modelo se estiman usando el **método simulado de máxima verosimilitud (SMLE)**:

$$\hat{\theta} = \arg\max \sum_n \sum_i y_{ni} \ln(\hat{P}_{ni})$$

### Modelo Nested Logit

El modelo Nested Logit es una extensión del modelo Logit que organiza las alternativas en 'nidos' o grupos que comparten características comunes, permitiendo modelar correlaciones entre opciones dentro de un mismo nido. Este modelo relaja la suposición de independencia de alternativas irrelevantes (IIA) al introducir un parámetro de correlación para cada nido.

La probabilidad de que un agente $n$ elija la alternativa $j$ se descompone como el producto de la probabilidad de elegir la alternativa $j$ dado que eligió el nodo $B_k$ que contiene la alternativa $j$, multiplicado por la probabilidad de elegir el nodo $B_k$:

$$P_{nj} = P_{nj|B_k} \cdot P_{nB_k}$$

Donde:

$$P_{nj|B_k} = \frac{e^{v_{nj}/\lambda_k}}{\sum_{i \in B_k} e^{v_{ni}/\lambda_k}}$$

$$P_{nB_k} = \frac{e^{w_{nk} + \lambda_k IV_{nk}}}{\sum_h e^{w_{nh} + \lambda_h IV_{nh}}}$$

Con $IV_{nk} = \ln\left(\sum_{j \in B_k} \exp\left(\frac{v_{nj}}{\lambda_k}\right)\right)$ el valor inclusivo del nido.

El conjunto de parámetros $\{\lambda_k\}_{k=1}^K$ mide el grado relativo de independencia en la parte no observable de la utilidad entre las alternativas del nido $k$. Probar que $\lambda_k = 1$ para todos los nidos podría llevarnos de vuelta al modelo logit simple.

### Modelo Mixed Logit

El modelo Mixed Logit es una extensión del modelo Logit que permite modelar la heterogeneidad de preferencias entre los individuos. A diferencia del modelo Logit tradicional, los parámetros de la utilidad $u_{ni}$ no son constantes, sino que varían aleatoriamente en la población.

La utilidad de un individuo $n$ para una alternativa $i$ se define como:

$$u_{ni} = \beta'_n x_{ni} + \varepsilon_{ni}$$

donde $\beta_n$ es un vector de coeficientes específicos de cada individuo, que sigue una distribución probabilística $f(\beta|\theta)$ en la población.

La probabilidad de elección de la alternativa $i$ por el individuo $n$ es:

$$P_{ni} = \int \frac{e^{\beta' x_{ni}}}{\sum_j e^{\beta' x_{nj}}} f(\beta|\theta) d\beta$$

donde $f(\beta|\theta)$ describe la distribución de los parámetros en la población, comúnmente asumida como normal multivariada: $\beta \sim N(b, V_b)$.

**Estimación:** Para estimar los parámetros, se utiliza el **método de máxima verosimilitud simulada (SMLE)**. La probabilidad simulada se calcula como:

$$\hat{P}_{ni} = \frac{1}{R} \sum_{r=1}^R \frac{e^{\beta'_r x_{ni}}}{\sum_j e^{\beta'_r x_{nj}}}$$

con $\beta_r$ siendo una muestra de $f(\beta|\theta)$ y $R$ el número de simulaciones.

### Logit con Clases Latentes

El modelo de Clases Latentes asume que la población está compuesta por un número finito de segmentos o clases, cada uno con parámetros específicos de preferencia. A diferencia del Mixed Logit, aquí se considera que las preferencias dentro de cada clase son homogéneas, pero varían entre clases.

La utilidad de un individuo $n$ para una alternativa $i$ en la clase $m$ se define como:

$$u_{ni|m} = \beta'_m x_{ni} + \varepsilon_{ni}$$

La probabilidad de que el individuo $n$ elija la alternativa $i$ se define como:

$$P_{ni} = \sum_m s_m \frac{e^{\beta'_m x_{ni}}}{\sum_j e^{\beta'_m x_{nj}}}$$

donde $s_m$ es la proporción de la población en la clase $m$ y $\beta_m$ son los parámetros específicos de la clase $m$.

**Estimación:** Para estimar los parámetros, se maximiza la función de verosimilitud:

$$LL(\{\beta_m, s_m\}_{m=1}^M) = \sum_n \sum_i y_{ni} \ln\left(\sum_m s_m \frac{e^{\beta'_m x_{ni}}}{\sum_j e^{\beta'_m x_{nj}}}\right)$$

con restricciones sobre $s_m$ para asegurar que representen proporciones válidas: $0 \leq s_m \leq 1$ y $\sum_m s_m = 1$.

## Metodología

La estimación de los modelos estructurales comparte una metodología:

1. **Especificación de la utilidad:** Definir la función de utilidad $u_{ni}$ con sus componentes determinísticas $v_{ni}$ y estocásticas $\varepsilon_{ni}$.

2. **Derivación de probabilidades:** Calcular las probabilidades de elección $P_{ni}$ según el modelo especificado (Logit, Probit, Nested Logit, Mixed Logit, o Clases Latentes).

3. **Construcción de la verosimilitud:** Escribir la función de (log-)verosimilitud basada en las observaciones $y_{ni}$.

4. **Estimación:** Para modelos con solución cerrada (Logit, Nested Logit, Clases Latentes), se utiliza **máxima verosimilitud directa**. Para modelos sin solución cerrada (Probit, Mixed Logit), se emplea **máxima verosimilitud simulada (SMLE)**.

5. **Evaluación:** Calcular métricas de ajuste como $\rho$ de McFadden, AIC, BIC y validar la significancia estadística de los parámetros.

6. **Interpretación:** Analizar los parámetros estimados, calcular elasticidades y evaluar implicaciones para la toma de decisiones.

## Problemas Teóricos

### Pregunta 1

Suponga que dispone de una muestra de tamaño $R$ de los parámetros que definen la utilidad de elección en un modelo logit. Describa cómo estimar la probabilidad que un consumidor $n$ elija la alternativa $i$.

### Pregunta 2

¿Cómo se calcula el Akaike Information Criterion (AIC) para un modelo cuya verosimilitud $f(X|\theta)$ es maximizada en un único valor de $\hat{\theta} = (\hat{\theta}_1, \hat{\theta}_2)$?

### Pregunta 3

Suponga que la componente determinística de la utilidad de los consumidores que pertenecen al segmento $i$ puede calcularse como $v(\theta_i)$. ¿Cuál es la probabilidad de elección en un modelo logit binario si asumimos que en la población solo existen dos clases caracterizadas por los set de parámetros $\theta_1$ y $\theta_2$ y además asumimos que la utilidad de no elegir está normalizada a 0?

### Pregunta 4

Describa cómo incluir que los consumidores eligen usando precios de referencia en un modelo logit.

### Pregunta 5

Explique una situación en la que un modelo mixed logit (o de heterogeneidad continua) podría preferirse a un modelo logit con clase latente.

### Pregunta 6

Suponga que estamos interesados en estudiar el efecto del ingreso de los hogares en la elasticidad precio en las compras de una categoría. Explicar por qué para estudiar este efecto es informativo poner atención al coeficiente $\delta$ que acompaña a $Precio \times Ingreso$ en la definición en la función de utilidad.

### Soluciones

1. Dicha probabilidad puede estimarse como:
   
   $$\hat{P}_{ni} = \frac{1}{R} \sum_{r=1}^R \frac{\exp(v_i(\theta^{(r)}))}{\sum_k \exp(v_k(\theta^{(r)}))}$$
   
   donde $v_i(\theta)$ es la componente determinística de la utilidad que el tomador de decisión deriva al elegir la alternativa $i$.

2. Aplicamos la definición directamente:
   
   $$AIC = -2 \ln(f(X|\hat{\theta})) + 2k = -2 \ln(f(X|\hat{\theta})) + 4$$

3. Sea $\pi$ la probabilidad de que un cliente pertenezca al segmento 1. Entonces, la probabilidad de elección viene dada por:
   
   $$P_{ni} = \pi \frac{\exp(v(\theta_1))}{1 + \exp(v(\theta_1))} + (1-\pi) \frac{\exp(v(\theta_2))}{1 + \exp(v(\theta_2))}$$

4. Definimos la componente determinística de la utilidad como:
   
   $$v_{nit} = \beta_0 + \beta_1(P_{nit} - RP_{nit})$$
   
   donde $P_{nit}$ es el precio de la alternativa $i$ al que se enfrenta el cliente $n$ en la ocasión de compra $t$ y $RP_{nit}$ es el precio de referencia que típicamente definimos como:
   
   $$RP_{nit} = \lambda RP_{nit-1} + (1-\lambda) P_{nit-1}$$
   
   Con esta especificación de la utilidad, la probabilidad de elección se calcula usando la fórmula estándar del modelo logit.

5. Cuando una distribución discreta no describe bien la heterogeneidad de los parámetros en la población. Por ejemplo, si esperamos que la distribución de un parámetro tenga colas pesadas (i.e. una proporción significativa de la población se aleja de la media), entonces se requerirá demasiadas clases para aproximar la heterogeneidad en la población.
   
6. El efecto del ingreso en la elasticidad precio depende directamente del parámetro $\gamma_1$ de la siguiente ecuación:
   
   $$\gamma_{precio} = \gamma_0 + \gamma_1 Ingreso$$
   
   Al reemplazar dicha ecuación en la definición de la función de utilidad obtenemos:
   
   $$u_{nit} = \beta_0 + \gamma_0 Precio + \gamma_1 Ingreso \cdot Precio$$

